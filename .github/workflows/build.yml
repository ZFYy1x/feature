name: Build APatch Kernel Module

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code with submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Android NDK
      run: |
        wget -q https://dl.google.com/android/repository/android-ndk-r27-linux.zip
        unzip -q android-ndk-r27-linux.zip -d /opt/
        echo "/opt/android-ndk-r27/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential
        cmake --version

    - name: Check KernelPatch submodule
      run: |
        echo "Checking for KernelPatch as submodule..."
        if [ -d "__KernelPatch_lib" ] || [ -d "../__KernelPatch_lib" ]; then
          echo "KernelPatch found"
          find . -name "compiler.h" -o -name "kpmodule.h" | head -5
        else
          echo "KernelPatch not found, checking .gitmodules..."
          cat .gitmodules || echo "No .gitmodules file"
        fi

    - name: Configure and build
      run: |
        cd src
        mkdir -p build
        cd build
        
        export CC=/opt/android-ndk-r27/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android33-clang
        
        cmake .. \
          -DCMAKE_C_COMPILER=$CC \
          -DCMAKE_BUILD_TYPE=Release
        
        make -j$(nproc)

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: kpm-module
        path: src/build/yuuki.kpm
        if-no-files-found: error
