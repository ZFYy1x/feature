name: Build APatch Kernel Module

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Clone and prepare KernelPatch
      run: |
        echo "Cloning KernelPatch..."
        git clone --depth 1 https://github.com/bmax121/KernelPatch.git ../__KernelPatch_lib
        
        echo "Searching for header files..."
        # 查找 compiler.h
        COMPILER_H_PATH=$(find ../__KernelPatch_lib -name "compiler.h" -type f | head -1)
        if [ -n "$COMPILER_H_PATH" ]; then
          echo "Found compiler.h at: $COMPILER_H_PATH"
          # 提取目录
          COMPILER_H_DIR=$(dirname "$COMPILER_H_PATH")
          echo "Directory: $COMPILER_H_DIR"
          
          # 创建符号链接或调整 CMakeLists.txt
          sed -i "s|set(KP_DIR \"../__KernelPatch_lib\")|set(KP_DIR \"../__KernelPatch_lib\")\ninclude_directories(\"$COMPILER_H_DIR\")|" src/CMakeLists.txt
        else
          echo "ERROR: compiler.h not found in KernelPatch!"
          find ../__KernelPatch_lib -type f -name "*.h" | head -20
        fi

    - name: Setup Android NDK
      run: |
        wget -q https://dl.google.com/android/repository/android-ndk-r27-linux.zip
        unzip -q android-ndk-r27-linux.zip -d /opt/
        echo "/opt/android-ndk-r27/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential

    - name: Build
      run: |
        cd src
        mkdir -p build
        cd build
        
        export CC=/opt/android-ndk-r27/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android33-clang
        
        # 尝试编译
        cmake .. -DCMAKE_C_COMPILER=$CC -DCMAKE_BUILD_TYPE=Release
        make -j$(nproc)

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: kpm-module
        path: src/build/yuuki.kpm
        if-no-files-found: error
