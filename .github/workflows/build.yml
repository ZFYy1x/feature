name: Build APatch Kernel Module

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Android NDK
      run: |
        echo "Downloading Android NDK r27..."
        wget -q https://dl.google.com/android/repository/android-ndk-r27-linux.zip
        echo "Unzipping NDK..."
        unzip -q android-ndk-r27-linux.zip -d /opt/
        
        echo "/opt/android-ndk-r27/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential
        cmake --version

    - name: Check project structure
      run: |
        echo "Project structure:"
        find . -type f -name "*.c" -o -name "*.h" -o -name "CMakeLists.txt" | sort
        echo ""
        echo "src directory contents:"
        ls -la src/

    - name: Configure CMake
      run: |
        echo "Entering src directory..."
        cd src
        echo "Current directory: $(pwd)"
        
        # 创建 build 目录
        mkdir -p build
        cd build
        
        # 设置编译器
        export CC=/opt/android-ndk-r27/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android33-clang
        
        echo "Using compiler: $CC"
        $CC --version
        
        # 运行 CMake
        echo "Running CMake..."
        cmake .. \
          -DCMAKE_C_COMPILER=$CC \
          -DCMAKE_BUILD_TYPE=Release

    - name: Build module
      run: |
        echo "Building..."
        cd src/build
        make -j$(nproc)

    - name: Check build output
      run: |
        echo "Checking build output in src/build..."
        ls -la src/build/
        
        # 重命名检查（根据 CMakeLists.txt 中的自定义命令）
        echo "Looking for .kpm file..."
        if [ -f "src/build/yuuki.kpm" ]; then
          echo "✓ Found yuuki.kpm"
          ls -lh src/build/yuuki.kpm
        elif [ -f "src/build/libyuuki.so" ]; then
          echo "Found libyuuki.so, renaming to yuuki.kpm..."
          cp src/build/libyuuki.so src/build/yuuki.kpm
          ls -lh src/build/yuuki.kpm
        else
          echo "✗ No output files found!"
          find src/build -type f | head -20
          exit 1
        fi

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: yuuki-kpm-module
        path: src/build/yuuki.kpm
        if-no-files-found: error
